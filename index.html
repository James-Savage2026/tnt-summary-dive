<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TnT Manager View - HVAC/R Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        walmart: {
                            blue: '#0071ce',
                            yellow: '#ffc220',
                            dark: '#004f9a',
                            light: '#f2f8fd'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .kpi-card { transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); }
        .table-row:hover { background-color: #f2f8fd; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-walmart-blue text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold">TnT - Manager View</h1>
                    <p class="text-blue-100 text-sm">Time in Target Dashboard | HVAC/R Performance</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-blue-100">Last Updated</p>
                    <p class="font-semibold" id="lastUpdated">Loading...</p>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sr. Director</label>
                    <select id="filterSrDirector" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-walmart-blue focus:border-walmart-blue">
                        <option value="">All Sr. Directors</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">FM Director</label>
                    <select id="filterDirector" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-walmart-blue focus:border-walmart-blue">
                        <option value="">All Directors</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Regional Manager</label>
                    <select id="filterManager" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-walmart-blue focus:border-walmart-blue">
                        <option value="">All Managers</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">FS Manager</label>
                    <select id="filterFSManager" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-walmart-blue focus:border-walmart-blue">
                        <option value="">All FS Managers</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Market</label>
                    <select id="filterMarket" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-walmart-blue focus:border-walmart-blue">
                        <option value="">All Markets</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="kpi-card bg-white rounded-lg shadow p-4 border-l-4 border-walmart-blue">
                <p class="text-sm text-gray-500 uppercase tracking-wide">Current TnT Ref</p>
                <p class="text-3xl font-bold text-walmart-blue" id="kpiCurrentRef">--</p>
                <p class="text-xs text-gray-400">Refrigeration</p>
            </div>
            <div class="kpi-card bg-white rounded-lg shadow p-4 border-l-4 border-blue-400">
                <p class="text-sm text-gray-500 uppercase tracking-wide">7-Day Avg</p>
                <p class="text-3xl font-bold text-blue-600" id="kpi7DayRef">--</p>
                <p class="text-xs text-gray-400">Refrigeration</p>
            </div>
            <div class="kpi-card bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
                <p class="text-sm text-gray-500 uppercase tracking-wide">30-Day Avg</p>
                <p class="text-3xl font-bold text-green-600" id="kpi30DayRef">--</p>
                <p class="text-xs text-gray-400">Refrigeration</p>
            </div>
            <div class="kpi-card bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
                <p class="text-sm text-gray-500 uppercase tracking-wide">90-Day Avg</p>
                <p class="text-3xl font-bold text-purple-600" id="kpi90DayRef">--</p>
                <p class="text-xs text-gray-400">Refrigeration</p>
            </div>
            <div class="kpi-card bg-white rounded-lg shadow p-4 border-l-4 border-walmart-yellow">
                <p class="text-sm text-gray-500 uppercase tracking-wide">HVAC 30-Day</p>
                <p class="text-3xl font-bold text-yellow-600" id="kpiHVAC">--</p>
                <p class="text-xs text-gray-400">HVAC Systems</p>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <p class="text-4xl font-bold text-gray-800" id="totalStores">--</p>
                <p class="text-sm text-gray-500">Total Stores</p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <p class="text-4xl font-bold text-red-600" id="totalLoss">--</p>
                <p class="text-sm text-gray-500">Total Loss ($)</p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <p class="text-4xl font-bold text-red-600" id="casesOutOfTarget">--</p>
                <p class="text-sm text-gray-500">Cases Out of Target</p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <p class="text-4xl font-bold text-gray-800" id="totalManagers">--</p>
                <p class="text-sm text-gray-500" id="managersLabel">Regional Managers</p>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Trend Chart -->
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="text-lg font-semibold text-gray-800 mb-4" id="trendChartTitle">TnT % Trend (Weekly)</h2>
                <div style="height: 300px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <!-- Dynamic Breakdown Chart -->
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="text-lg font-semibold text-gray-800 mb-4" id="breakdownChartTitle">Performance by Sr. Director</h2>
                <div style="height: 300px;">
                    <canvas id="breakdownChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Manager Performance Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-800" id="tableTitle">Manager Performance</h2>
                <input type="text" id="tableSearch" placeholder="Search..." 
                       class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50" id="tableHeader">
                        <!-- Dynamic header -->
                    </thead>
                    <tbody id="managerTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">üìä Insights & Analysis</h3>
            <div id="insightsContent" class="text-sm text-blue-700 space-y-2">
                <p>Loading insights...</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-4 mt-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm">
            <p>TnT Manager View Dashboard | Built with üê∂ Code Puppy</p>
            <p class="text-xs mt-1">Data Source: BigQuery (re-crystal-mdm-prod.crystal.store_tabular_view)</p>
        </div>
    </footer>

    <script>
        // Register Chart.js datalabels plugin
        Chart.register(ChartDataLabels);
        
        // Global data
        let storeData = [];
        let trendData = [];
        let filteredData = [];
        let filteredTrendData = [];
        let currentSort = { field: 'twt_ref_30_day', direction: 'desc' };
        let trendChart, breakdownChart;

        // Load data
        async function loadData() {
            try {
                const [storeRes, trendRes] = await Promise.all([
                    fetch('store_data.json'),
                    fetch('trend_data.json')
                ]);
                storeData = (await storeRes.json()).map(d => ({
                    ...d,
                    store_number: d.store_number,
                    twt_ref: parseFloat(d.twt_ref) || null,
                    twt_ref_7_day: parseFloat(d.twt_ref_7_day) || null,
                    twt_ref_30_day: parseFloat(d.twt_ref_30_day) || null,
                    twt_ref_90_day: parseFloat(d.twt_ref_90_day) || null,
                    twt_hvac: parseFloat(d.twt_hvac) || null,
                    twt_hvac_7_day: parseFloat(d.twt_hvac_7_day) || null,
                    twt_hvac_30_day: parseFloat(d.twt_hvac_30_day) || null,
                    twt_hvac_90_day: parseFloat(d.twt_hvac_90_day) || null,
                    case_count: parseInt(d.case_count) || 0,
                    cases_out_of_target: parseInt(d.cases_out_of_target) || 0,
                    total_loss: parseFloat(d.total_loss) || 0
                }));
                trendData = (await trendRes.json()).map(d => ({
                    ...d,
                    avg_weekly_tit: parseFloat(d.avg_weekly_tit) || null,
                    avg_monthly_tit: parseFloat(d.avg_monthly_tit) || null,
                    wmt_year_nbr: parseInt(d.wmt_year_nbr),
                    wmt_week_nbr: parseInt(d.wmt_week_nbr),
                    fm_sr_director: d.fm_sr_director,
                    fm_director: d.fm_director,
                    fm_regional_mgr: d.fm_regional_mgr
                }));
                filteredData = [...storeData];
                filteredTrendData = [...trendData];
                
                document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString();
                
                populateFilters();
                updateDashboard();
                initCharts();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('lastUpdated').textContent = 'Error loading data';
            }
        }

        // Get current filter context to determine chart/table display level
        function getFilterContext() {
            const srDir = document.getElementById('filterSrDirector').value;
            const dir = document.getElementById('filterDirector').value;
            const mgr = document.getElementById('filterManager').value;
            const fsMgr = document.getElementById('filterFSManager').value;
            
            if (fsMgr) return { level: 'store', groupBy: 'store_number', label: 'Stores', parent: 'fs_manager_name' };
            if (mgr) return { level: 'fs_manager', groupBy: 'fs_manager_name', label: 'FS Managers', parent: 'fm_regional_manager_name' };
            if (dir) return { level: 'manager', groupBy: 'fm_regional_manager_name', label: 'Regional Managers', parent: 'fm_director_name' };
            if (srDir) return { level: 'director', groupBy: 'fm_director_name', label: 'Directors', parent: 'fm_sr_director_name' };
            return { level: 'sr_director', groupBy: 'fm_sr_director_name', label: 'Sr. Directors', parent: null };
        }

        // Populate filter dropdowns
        function populateFilters() {
            const srDirectors = [...new Set(storeData.map(d => d.fm_sr_director_name).filter(Boolean))].sort();
            const directors = [...new Set(storeData.map(d => d.fm_director_name).filter(Boolean))].sort();
            const managers = [...new Set(storeData.map(d => d.fm_regional_manager_name).filter(Boolean))].sort();
            const fsManagers = [...new Set(storeData.map(d => d.fs_manager_name).filter(Boolean))].sort();
            const markets = [...new Set(storeData.map(d => d.fs_market).filter(Boolean))].sort();

            populateSelect('filterSrDirector', srDirectors, 'All Sr. Directors');
            populateSelect('filterDirector', directors, 'All Directors');
            populateSelect('filterManager', managers, 'All Managers');
            populateSelect('filterFSManager', fsManagers, 'All FS Managers');
            populateSelect('filterMarket', markets, 'All Markets');
        }

        function populateSelect(id, options, defaultLabel) {
            const select = document.getElementById(id);
            const currentValue = select.value;
            select.innerHTML = `<option value="">${defaultLabel}</option>` + 
                options.map(o => `<option value="${o}">${o}</option>`).join('');
            select.value = currentValue;
        }

        // Update dependent filters based on selection
        function updateDependentFilters() {
            const srDir = document.getElementById('filterSrDirector').value;
            const dir = document.getElementById('filterDirector').value;
            const mgr = document.getElementById('filterManager').value;
            
            let filtered = [...storeData];
            
            if (srDir) {
                filtered = filtered.filter(d => d.fm_sr_director_name === srDir);
                const directors = [...new Set(filtered.map(d => d.fm_director_name).filter(Boolean))].sort();
                populateSelect('filterDirector', directors, 'All Directors');
            }
            
            if (dir) {
                filtered = filtered.filter(d => d.fm_director_name === dir);
                const managers = [...new Set(filtered.map(d => d.fm_regional_manager_name).filter(Boolean))].sort();
                populateSelect('filterManager', managers, 'All Managers');
            }
            
            if (mgr) {
                filtered = filtered.filter(d => d.fm_regional_manager_name === mgr);
                const fsManagers = [...new Set(filtered.map(d => d.fs_manager_name).filter(Boolean))].sort();
                populateSelect('filterFSManager', fsManagers, 'All FS Managers');
            }
        }

        // Filter data
        function applyFilters() {
            const srDir = document.getElementById('filterSrDirector').value;
            const dir = document.getElementById('filterDirector').value;
            const mgr = document.getElementById('filterManager').value;
            const fsMgr = document.getElementById('filterFSManager').value;
            const mkt = document.getElementById('filterMarket').value;

            // Filter store data
            filteredData = storeData.filter(d => {
                if (srDir && d.fm_sr_director_name !== srDir) return false;
                if (dir && d.fm_director_name !== dir) return false;
                if (mgr && d.fm_regional_manager_name !== mgr) return false;
                if (fsMgr && d.fs_manager_name !== fsMgr) return false;
                if (mkt && d.fs_market !== mkt) return false;
                return true;
            });

            // Filter trend data
            filteredTrendData = trendData.filter(d => {
                if (srDir && d.fm_sr_director !== srDir) return false;
                if (dir && d.fm_director !== dir) return false;
                if (mgr && d.fm_regional_mgr !== mgr) return false;
                return true;
            });

            updateDependentFilters();
            updateDashboard();
            updateCharts();
        }

        // Update KPIs and table
        function updateDashboard() {
            const validRef = filteredData.filter(d => d.twt_ref !== null && !isNaN(d.twt_ref));
            const valid7d = filteredData.filter(d => d.twt_ref_7_day !== null && !isNaN(d.twt_ref_7_day));
            const valid30d = filteredData.filter(d => d.twt_ref_30_day !== null && !isNaN(d.twt_ref_30_day));
            const valid90d = filteredData.filter(d => d.twt_ref_90_day !== null && !isNaN(d.twt_ref_90_day));
            const validHvac = filteredData.filter(d => d.twt_hvac_30_day !== null && !isNaN(d.twt_hvac_30_day));

            // KPIs
            const avgRef = validRef.length ? (validRef.reduce((s, d) => s + d.twt_ref, 0) / validRef.length) : 0;
            const avg7d = valid7d.length ? (valid7d.reduce((s, d) => s + d.twt_ref_7_day, 0) / valid7d.length) : 0;
            const avg30d = valid30d.length ? (valid30d.reduce((s, d) => s + d.twt_ref_30_day, 0) / valid30d.length) : 0;
            const avg90d = valid90d.length ? (valid90d.reduce((s, d) => s + d.twt_ref_90_day, 0) / valid90d.length) : 0;
            const avgHvac = validHvac.length ? (validHvac.reduce((s, d) => s + d.twt_hvac_30_day, 0) / validHvac.length) : 0;

            document.getElementById('kpiCurrentRef').textContent = avgRef.toFixed(1) + '%';
            document.getElementById('kpi7DayRef').textContent = avg7d.toFixed(1) + '%';
            document.getElementById('kpi30DayRef').textContent = avg30d.toFixed(1) + '%';
            document.getElementById('kpi90DayRef').textContent = avg90d.toFixed(1) + '%';
            document.getElementById('kpiHVAC').textContent = avgHvac.toFixed(1) + '%';

            // Summary stats
            const totalLoss = filteredData.reduce((s, d) => s + (d.total_loss || 0), 0);
            const casesOOT = filteredData.reduce((s, d) => s + (d.cases_out_of_target || 0), 0);
            
            const context = getFilterContext();
            const uniqueItems = [...new Set(filteredData.map(d => d[context.groupBy]))];

            document.getElementById('totalStores').textContent = filteredData.length.toLocaleString();
            document.getElementById('totalLoss').textContent = '$' + totalLoss.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('casesOutOfTarget').textContent = casesOOT.toLocaleString();
            document.getElementById('totalManagers').textContent = uniqueItems.length;
            document.getElementById('managersLabel').textContent = context.label;

            // Update table
            updateManagerTable();
            updateInsights(avgRef, avg30d, avgHvac, casesOOT, filteredData.length, totalLoss);
        }

        // Aggregate and update table based on context
        function updateManagerTable() {
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
            const context = getFilterContext();
            
            // Update table title
            document.getElementById('tableTitle').textContent = `Performance by ${context.label}`;
            
            // Update table header
            const headerHtml = context.level === 'store' ? `
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Store #</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">FS Manager</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('twt_ref')">Current % ‚áÖ</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('twt_ref_7_day')">7-Day ‚áÖ</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('twt_ref_30_day')">30-Day ‚áÖ</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('twt_hvac_30_day')">HVAC 30d ‚áÖ</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Loss $</th>
                </tr>
            ` : `
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('parent')">Parent ‚áÖ</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('name')">${context.label.slice(0, -1)} ‚áÖ</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('store_count')">Stores ‚áÖ</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('twt_ref')">Current % ‚áÖ</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('twt_ref_30_day')">30-Day ‚áÖ</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('twt_hvac_30_day')">HVAC 30d ‚áÖ</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100" onclick="sortTable('total_loss')">Loss $ ‚áÖ</th>
                </tr>
            `;
            document.getElementById('tableHeader').innerHTML = headerHtml;
            
            let rows = [];
            
            if (context.level === 'store') {
                rows = filteredData.map(d => ({
                    name: d.store_number,
                    parent: d.fs_manager_name || '-',
                    store_count: 1,
                    twt_ref: d.twt_ref,
                    twt_ref_7_day: d.twt_ref_7_day,
                    twt_ref_30_day: d.twt_ref_30_day,
                    twt_hvac_30_day: d.twt_hvac_30_day,
                    total_loss: d.total_loss || 0
                }));
            } else {
                const groupMap = new Map();
                filteredData.forEach(d => {
                    const key = d[context.groupBy];
                    if (!key) return;
                    if (!groupMap.has(key)) {
                        groupMap.set(key, {
                            name: key,
                            parent: context.parent ? d[context.parent] : '-',
                            stores: [],
                            twt_ref_sum: 0, twt_ref_count: 0,
                            twt_ref_30_day_sum: 0, twt_ref_30_day_count: 0,
                            twt_hvac_30_day_sum: 0, twt_hvac_30_day_count: 0,
                            total_loss: 0
                        });
                    }
                    const g = groupMap.get(key);
                    g.stores.push(d.store_number);
                    if (d.twt_ref != null && !isNaN(d.twt_ref)) { g.twt_ref_sum += d.twt_ref; g.twt_ref_count++; }
                    if (d.twt_ref_30_day != null && !isNaN(d.twt_ref_30_day)) { g.twt_ref_30_day_sum += d.twt_ref_30_day; g.twt_ref_30_day_count++; }
                    if (d.twt_hvac_30_day != null && !isNaN(d.twt_hvac_30_day)) { g.twt_hvac_30_day_sum += d.twt_hvac_30_day; g.twt_hvac_30_day_count++; }
                    g.total_loss += d.total_loss || 0;
                });

                rows = Array.from(groupMap.values()).map(g => ({
                    name: g.name,
                    parent: g.parent || '-',
                    store_count: g.stores.length,
                    twt_ref: g.twt_ref_count ? g.twt_ref_sum / g.twt_ref_count : null,
                    twt_ref_30_day: g.twt_ref_30_day_count ? g.twt_ref_30_day_sum / g.twt_ref_30_day_count : null,
                    twt_hvac_30_day: g.twt_hvac_30_day_count ? g.twt_hvac_30_day_sum / g.twt_hvac_30_day_count : null,
                    total_loss: g.total_loss
                }));
            }

            if (searchTerm) {
                rows = rows.filter(r => 
                    String(r.name).toLowerCase().includes(searchTerm) ||
                    String(r.parent).toLowerCase().includes(searchTerm)
                );
            }

            rows.sort((a, b) => {
                let aVal = a[currentSort.field];
                let bVal = b[currentSort.field];
                if (aVal == null) aVal = currentSort.direction === 'asc' ? Infinity : -Infinity;
                if (bVal == null) bVal = currentSort.direction === 'asc' ? Infinity : -Infinity;
                if (typeof aVal === 'string') {
                    return currentSort.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
            });

            const tbody = document.getElementById('managerTableBody');
            tbody.innerHTML = context.level === 'store' ? 
                rows.map(r => `
                    <tr class="table-row hover:bg-blue-50">
                        <td class="px-4 py-2 text-sm font-medium text-gray-900">${r.name}</td>
                        <td class="px-4 py-2 text-sm text-gray-600">${r.parent}</td>
                        <td class="px-4 py-2 text-sm text-center font-semibold ${getColorClass(r.twt_ref)}">${formatPct(r.twt_ref)}</td>
                        <td class="px-4 py-2 text-sm text-center ${getColorClass(r.twt_ref_7_day)}">${formatPct(r.twt_ref_7_day)}</td>
                        <td class="px-4 py-2 text-sm text-center ${getColorClass(r.twt_ref_30_day)}">${formatPct(r.twt_ref_30_day)}</td>
                        <td class="px-4 py-2 text-sm text-center ${getColorClass(r.twt_hvac_30_day)}">${formatPct(r.twt_hvac_30_day)}</td>
                        <td class="px-4 py-2 text-sm text-center text-red-600 font-medium">$${r.total_loss.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    </tr>
                `).join('') :
                rows.map(r => `
                    <tr class="table-row hover:bg-blue-50">
                        <td class="px-4 py-2 text-sm text-gray-600">${r.parent}</td>
                        <td class="px-4 py-2 text-sm font-medium text-gray-900">${r.name}</td>
                        <td class="px-4 py-2 text-sm text-center text-gray-600">${r.store_count}</td>
                        <td class="px-4 py-2 text-sm text-center font-semibold ${getColorClass(r.twt_ref)}">${formatPct(r.twt_ref)}</td>
                        <td class="px-4 py-2 text-sm text-center ${getColorClass(r.twt_ref_30_day)}">${formatPct(r.twt_ref_30_day)}</td>
                        <td class="px-4 py-2 text-sm text-center ${getColorClass(r.twt_hvac_30_day)}">${formatPct(r.twt_hvac_30_day)}</td>
                        <td class="px-4 py-2 text-sm text-center text-red-600 font-medium">$${r.total_loss.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    </tr>
                `).join('');
        }

        function getColorClass(val) {
            if (val == null) return 'text-gray-400';
            if (val >= 90) return 'text-green-600';
            if (val >= 85) return 'text-yellow-600';
            return 'text-red-600';
        }

        function formatPct(val) {
            return val != null ? val.toFixed(1) + '%' : '-';
        }

        function sortTable(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'desc';
            }
            updateManagerTable();
        }

        // Charts
        function initCharts() {
            updateCharts();
        }

        function updateCharts() {
            updateTrendChart();
            updateBreakdownChart();
        }

        function updateTrendChart() {
            const context = getFilterContext();
            
            // Update title based on filter
            const srDir = document.getElementById('filterSrDirector').value;
            const dir = document.getElementById('filterDirector').value;
            const mgr = document.getElementById('filterManager').value;
            let titleSuffix = '';
            if (mgr) titleSuffix = ` - ${mgr}`;
            else if (dir) titleSuffix = ` - ${dir}`;
            else if (srDir) titleSuffix = ` - ${srDir}`;
            document.getElementById('trendChartTitle').textContent = `TnT % Trend${titleSuffix}`;

            // Aggregate trend data by week
            const weekMap = new Map();
            filteredTrendData.forEach(d => {
                const key = `${d.wmt_year_nbr}-W${String(d.wmt_week_nbr).padStart(2, '0')}`;
                if (!weekMap.has(key)) {
                    weekMap.set(key, {
                        label: key,
                        year_month: d.year_month,
                        weekly_sum: 0, weekly_count: 0,
                        monthly_sum: 0, monthly_count: 0
                    });
                }
                const w = weekMap.get(key);
                if (d.avg_weekly_tit != null) { w.weekly_sum += d.avg_weekly_tit; w.weekly_count++; }
                if (d.avg_monthly_tit != null) { w.monthly_sum += d.avg_monthly_tit; w.monthly_count++; }
            });

            const weeks = Array.from(weekMap.values())
                .map(w => ({
                    label: w.year_month || w.label,
                    weekly: w.weekly_count ? w.weekly_sum / w.weekly_count : null,
                    monthly: w.monthly_count ? w.monthly_sum / w.monthly_count : null
                }))
                .sort((a, b) => a.label.localeCompare(b.label));

            if (trendChart) trendChart.destroy();

            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: weeks.map(d => d.label),
                    datasets: [{
                        label: 'Weekly TnT %',
                        data: weeks.map(d => d.weekly),
                        borderColor: '#0071ce',
                        backgroundColor: 'rgba(0, 113, 206, 0.1)',
                        fill: true,
                        tension: 0.3
                    }, {
                        label: 'Monthly TnT %',
                        data: weeks.map(d => d.monthly),
                        borderColor: '#ffc220',
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: { min: 80, max: 100, ticks: { callback: v => v + '%' } },
                        x: { 
                            ticks: { 
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function updateBreakdownChart() {
            const context = getFilterContext();
            
            document.getElementById('breakdownChartTitle').textContent = `Performance by ${context.label}`;
            
            const groupMap = new Map();
            filteredData.forEach(d => {
                const key = d[context.groupBy];
                if (!key) return;
                if (!groupMap.has(key)) {
                    groupMap.set(key, { sum: 0, count: 0 });
                }
                if (d.twt_ref_30_day != null && !isNaN(d.twt_ref_30_day)) {
                    groupMap.get(key).sum += d.twt_ref_30_day;
                    groupMap.get(key).count++;
                }
            });

            const groups = Array.from(groupMap.entries())
                .map(([name, data]) => ({ name, avg: data.count ? data.sum / data.count : 0 }))
                .sort((a, b) => b.avg - a.avg)
                .slice(0, 15);

            if (breakdownChart) breakdownChart.destroy();
            
            const ctx = document.getElementById('breakdownChart').getContext('2d');
            breakdownChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: groups.map(d => d.name.length > 18 ? d.name.substring(0, 18) + '...' : d.name),
                    datasets: [{
                        label: '30-Day TnT %',
                        data: groups.map(d => d.avg),
                        backgroundColor: groups.map(d => d.avg >= 87 ? '#22c55e' : d.avg >= 85 ? '#eab308' : '#ef4444'),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (items) => groups[items[0].dataIndex].name
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'start',
                            offset: 4,
                            color: '#fff',
                            font: { weight: 'bold', size: 11 },
                            formatter: (value) => value.toFixed(1) + '%'
                        }
                    },
                    scales: {
                        x: { min: 80, max: 100, ticks: { callback: v => v + '%' } }
                    }
                }
            });
        }

        function updateInsights(avgRef, avg30d, avgHvac, casesOOT, storeCount, totalLoss) {
            const context = getFilterContext();
            const insights = [];
            
            if (avg30d >= 87) {
                insights.push(`‚úÖ <strong>Strong Performance:</strong> 30-day refrigeration TnT is at ${avg30d.toFixed(1)}%, above the 87% target.`);
            } else {
                insights.push(`‚ö†Ô∏è <strong>Attention Needed:</strong> 30-day refrigeration TnT is at ${avg30d.toFixed(1)}%, below the 87% target.`);
            }

            if (avgHvac >= 90) {
                insights.push(`‚úÖ <strong>HVAC Systems:</strong> Performing well at ${avgHvac.toFixed(1)}% time in target.`);
            } else {
                insights.push(`‚ö†Ô∏è <strong>HVAC Opportunity:</strong> HVAC systems at ${avgHvac.toFixed(1)}% - review underperforming stores.`);
            }

            insights.push(`üí∞ <strong>Total Loss:</strong> $${totalLoss.toLocaleString(undefined, {maximumFractionDigits: 0})} across ${storeCount.toLocaleString()} stores.`);
            insights.push(`üìä <strong>Cases Out of Target:</strong> ${casesOOT.toLocaleString()} cases need attention.`);

            const groupMap = new Map();
            filteredData.forEach(d => {
                const key = d[context.groupBy];
                if (!key || d.twt_ref_30_day == null) return;
                if (!groupMap.has(key)) groupMap.set(key, { sum: 0, count: 0 });
                groupMap.get(key).sum += d.twt_ref_30_day;
                groupMap.get(key).count++;
            });
            
            const groupAvgs = Array.from(groupMap.entries())
                .map(([name, data]) => ({ name, avg: data.sum / data.count }))
                .sort((a, b) => b.avg - a.avg);
            
            if (groupAvgs.length > 0) {
                const best = groupAvgs[0];
                const worst = groupAvgs[groupAvgs.length - 1];
                insights.push(`üèÜ <strong>Top ${context.label.slice(0, -1)}:</strong> ${best.name} at ${best.avg.toFixed(1)}%`);
                if (groupAvgs.length > 1) {
                    insights.push(`üìâ <strong>Needs Support:</strong> ${worst.name} at ${worst.avg.toFixed(1)}%`);
                }
            }

            document.getElementById('insightsContent').innerHTML = insights.map(i => `<p>${i}</p>`).join('');
        }

        // Event listeners
        document.getElementById('filterSrDirector').addEventListener('change', applyFilters);
        document.getElementById('filterDirector').addEventListener('change', applyFilters);
        document.getElementById('filterManager').addEventListener('change', applyFilters);
        document.getElementById('filterFSManager').addEventListener('change', applyFilters);
        document.getElementById('filterMarket').addEventListener('change', applyFilters);
        document.getElementById('tableSearch').addEventListener('input', updateManagerTable);

        // Initialize
        loadData();
    </script>
</body>
</html>